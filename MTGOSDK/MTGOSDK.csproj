<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFrameworks>netstandard2.0;net8.0-windows</TargetFrameworks>
    <LangVersion>Latest</LangVersion>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <NoWarn>$(NoWarn);
      <!-- Disables unenforcable nullable warnings - breaks static analysis -->
      CS8597;CS8600;CS8602;CS8603;CS8604;CS8625;CS8767;CS9113;IDE0065;
      <!-- Disable warnings for incompatible TFMs required for building -->
      NU1702;MSB3277;
      <!-- FIXME: From RemoteNET library -->
      CS8601;CS8608;CS8610;CS8618;CS8619;CS8620;CS8765;
    </NoWarn>
  </PropertyGroup>

  <!-- For builds used by the ScubaDiver assembly, exclude compiling the API -->
  <PropertyGroup Condition="'$(TargetFramework)' == 'netstandard2.0'">
    <DefaultItemExcludes>$(DefaultItemExcludes);src\API\**</DefaultItemExcludes>
  </PropertyGroup>

  <!-- Import MTGOSDK package properties -->
  <Import Project="MTGOSDK.pkg.props"
          Condition="'$(TargetFramework)' != 'netstandard2.0'" />

  <ItemGroup>
		<PackageReference Include="Microsoft.CSharp"
                      Version="4.7.0" />
    <PackageReference Include="Microsoft.Diagnostics.Runtime"
                      Version="3.1.512801" />
    <PackageReference Include="ImpromptuInterface"
                      Version="8.0.4" />
    <PackageReference Include="Newtonsoft.Json"
                      Version="13.0.3" />
    <ProjectReference Include="$(SolutionDir)\MTGOSDK.Win32\MTGOSDK.Win32.csproj" />
    <!-- Compatibility layers for .netstandard-2.0 -->
    <PackageReference Include="Meziantou.Polyfill"
                      Version="1.0.37"
                      Condition="'$(TargetFramework)' == 'netstandard2.0'" />
    <!-- Build-time dependencies for MTGOSDK.MSBuild -->
    <PackageReference Include="ILRepack"
                      Version="2.0.30"
                      PrivateAssets="all"
                      Condition="'$(TargetFramework)' != 'netstandard2.0'" />
    <PackageReference Include="ILRepack.Lib.MSBuild.Task"
                      Version="2.0.29"
                      PrivateAssets="all"
                      Condition="'$(TargetFramework)' != 'netstandard2.0'" />
  </ItemGroup>

  <!-- Import MTGOSDK reference assemblies -->
  <Import Project="MTGOSDK.ref.props"
          Condition="'$(TargetFramework)' != 'netstandard2.0'" />

  <!-- Configures build-time resource dependencies for the main library -->
  <Target Name="CollectResourceProjects"
          BeforeTargets="ResolveLockFileReferences;ResolveProjectReferences"
          Condition="'$(UseFullSDKPaths)' == 'true'">
    <!-- Build resource projects to bundle inside the main library -->
    <ItemGroup Condition="'$(TargetFramework)' != 'netstandard2.0'">
      <ResourceProjects Include="..\third_party\ScubaDiver\ScubaDiver.csproj" />
      <ResourceProjects Include="..\third_party\SharpNeedle\src\Bootstrapper\*.vcxproj" />
      <ResourceProjects Include="..\third_party\SharpNeedle\src\Launcher\*.vcxproj" />
    </ItemGroup>
    <!-- Indicates to MSBuild which resource projects should be built -->
    <ItemGroup Condition="'@(ResourceProjects)' != ''">
      <ProjectReference Include="@(ResourceProjects)"
                        ReferenceOutputAssembly="false"
                        Private="false" />
    </ItemGroup>
  </Target>

  <!-- Embed assembly resources into the main library -->
  <Target Name="EmbedResources"
          BeforeTargets="CoreCompile;AssignTargetPaths"
          DependsOnTargets="CollectResourceProjects">
    <!-- Embed the MTGO manifest for verifying assembly compatibility -->
    <ItemGroup Condition="'$(MTGOVersion)' != ''">
      <EmbeddedResource Include="$(MTGOAppDir)\MTGO.exe.manifest"
                        LogicalName="Manifests\MTGO" />
    </ItemGroup>
    <!-- Bundle resource projects' build artifacts into the main library -->
    <ItemGroup Condition="'$(TargetFramework)' != 'netstandard2.0'">
      <ResourceFiles Include="$(SolutionDir)\dist\$(Configuration)\Win32\*.*" />
      <ResourceFiles Include="$(SolutionDir)\dist\$(Configuration)\x64\*.*" />
      <ResourceFiles Include="$(SolutionDir)\dist\$(Configuration)\*.*" />
    </ItemGroup>
    <!-- Embed all resource files into the MTGOSDK assembly -->
    <ItemGroup Condition="'@(ResourceFiles)' != ''">
      <EmbeddedResource Include="@(ResourceFiles)"
                        LogicalName="Resources\%(Filename)%(Extension)"
                        Condition="'%(Extension)' == '.dll' OR '%(Extension)' == '.exe'" />
    </ItemGroup>
	</Target>

</Project>