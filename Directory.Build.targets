<Project>

  <Target Name="CleanProject"
          BeforeTargets="Clean">
    <ItemGroup>
      <FoldersToClean Include="$(DistDir)" />
      <FoldersToClean Include="$(FeedOutputPath)"
                      Condition="'$(UseLocalFeed)' != 'true'" />
      <FoldersToClean Include="$(PackageOutputPath)"
                      Condition="'$(UseLocalFeed)' != 'true'" />
      <FoldersToClean Include="$(MSBuildProjectDirectory)\bin" />
      <FoldersToClean Include="$(MSBuildProjectDirectory)\obj" />
    </ItemGroup>
    <RemoveDir Directories="@(FoldersToClean)" />
  </Target>

  <Target Name="UpdateFeed"
          AfterTargets="Pack">
    <!-- Query all existing package versions in the feed -->
    <ItemGroup>
      <_SDKPackagePaths Include="$(FeedOutputPath)\**\*.nupkg" />
      <_SDKPackagePaths>
        <VersionPath>$([System.IO.Path]::GetDirectoryName('%(Identity)').Replace('$(FeedOutputPath)\', ''))</VersionPath>
      </_SDKPackagePaths>
      <_SDKPackagePaths>
        <Version>$([System.IO.Path]::GetFileName('%(VersionPath)'))</Version>
      </_SDKPackagePaths>
    </ItemGroup>

    <!-- Clean the local feed of old package versions -->
    <PropertyGroup>
      <FeedPackagePath>$(FeedOutputPath)\$(MSBuildProjectName.ToLower())</FeedPackagePath>
    </PropertyGroup>
    <RemoveDir Directories="@(_SDKPackagePaths->'$(FeedOutputPath)\%(VersionPath)');
                            @(_SDKPackagePaths->'$(NuGetPackageRoot)\%(VersionPath)')"
               Condition="Exists($(FeedPackagePath))" />

    <!-- Add the built package to the local feed -->
    <ItemGroup>
      <_SDKPackageSources Include="$(PackageOutputPath)\$(MSBuildProjectName).*.nupkg" />
    </ItemGroup>
    <PropertyGroup>
      <SDKPackageVersion>%(_SDKPackagePaths.Version)</SDKPackageVersion>
      <PackagePath>$(PackageOutputPath)\$(MSBuildProjectName).$(SDKPackageVersion).nupkg</PackagePath>
      <PackagePath Condition="!Exists($(PackagePath))">%(_SDKPackageSources.Identity)</PackagePath>
    </PropertyGroup>
    <Exec Command="$(NuGetExePath) add $(PackagePath) -Source $(FeedOutputPath)" />
  </Target>

</Project>